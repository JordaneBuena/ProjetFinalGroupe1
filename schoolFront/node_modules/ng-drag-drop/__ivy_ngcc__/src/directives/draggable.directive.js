"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var core_1 = require("@angular/core");
var ng_drag_drop_service_1 = require("../services/ng-drag-drop.service");
var dom_helper_1 = require("../shared/dom-helper");
var ɵngcc0 = require('@angular/core');
var ɵngcc1 = require('../services/ng-drag-drop.service');
var Draggable = /** @class */ (function () {
    function Draggable(el, renderer, ng2DragDropService, zone) {
        this.el = el;
        this.renderer = renderer;
        this.ng2DragDropService = ng2DragDropService;
        this.zone = zone;
        /**
         * Currently not used
         */
        this.dragEffect = 'move';
        /**
         * Defines compatible drag drop pairs. Values must match both in draggable and droppable.dropScope.
         */
        this.dragScope = 'default';
        /**
         * The CSS class applied to a draggable element. If a dragHandle is defined then its applied to that handle
         * element only. By default it is used to change the mouse over pointer.
         */
        this.dragHandleClass = 'drag-handle';
        /**
         * CSS class applied on the source draggable element while being dragged.
         */
        this.dragClass = 'drag-border';
        /**
         * CSS class applied on the drag ghost when being dragged.
         */
        this.dragTransitClass = 'drag-transit';
        /**
         * Event fired when Drag is started
         */
        this.onDragStart = new core_1.EventEmitter();
        /**
         * Event fired while the element is being dragged
         */
        this.onDrag = new core_1.EventEmitter();
        /**
         * Event fired when drag ends
         */
        this.onDragEnd = new core_1.EventEmitter();
        /**
         * @private
         * Backing field for the dragEnabled property
         */
        this._dragEnabled = true;
    }
    Object.defineProperty(Draggable.prototype, "dragImage", {
        get: function () {
            return this._dragImage;
        },
        /**
         * The url to image that will be used as custom drag image when the draggable is being dragged.
         */
        set: function (value) {
            this._dragImage = value;
            this.dragImageElement = new Image();
            this.dragImageElement.src = this.dragImage;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(Draggable.prototype, "dragEnabled", {
        get: function () {
            return this._dragEnabled;
        },
        /**
         * Defines if drag is enabled. `true` by default.
         */
        set: function (value) {
            this._dragEnabled = value;
            this.applyDragHandleClass();
        },
        enumerable: true,
        configurable: true
    });
    ;
    Draggable.prototype.ngOnInit = function () {
        this.applyDragHandleClass();
    };
    Draggable.prototype.ngOnDestroy = function () {
        this.unbindDragListeners();
    };
    Draggable.prototype.dragStart = function (e) {
        var _this = this;
        if (this.allowDrag()) {
            // This is a kludgy approach to apply CSS to the drag helper element when an image is being dragged.
            dom_helper_1.DomHelper.addClass(this.el, this.dragTransitClass);
            setTimeout(function () {
                dom_helper_1.DomHelper.addClass(_this.el, _this.dragClass);
                dom_helper_1.DomHelper.removeClass(_this.el, _this.dragTransitClass);
            }, 10);
            this.ng2DragDropService.dragData = this.dragData;
            this.ng2DragDropService.scope = this.dragScope;
            // Firefox requires setData() to be called otherwise the drag does not work.
            // We don't use setData() to transfer data anymore so this is just a dummy call.
            if (e.dataTransfer != null) {
                e.dataTransfer.setData('text', '');
            }
            // Set dragImage
            if (this.dragImage) {
                e.dataTransfer.setDragImage(this.dragImageElement, 0, 0);
            }
            e.stopPropagation();
            this.onDragStart.emit(e);
            this.ng2DragDropService.onDragStart.next();
            this.zone.runOutsideAngular(function () {
                _this.unbindDragListener = _this.renderer.listen(_this.el.nativeElement, 'drag', function (dragEvent) {
                    _this.drag(dragEvent);
                });
            });
        }
        else {
            e.preventDefault();
        }
    };
    Draggable.prototype.drag = function (e) {
        this.onDrag.emit(e);
    };
    Draggable.prototype.dragEnd = function (e) {
        this.unbindDragListeners();
        dom_helper_1.DomHelper.removeClass(this.el, this.dragClass);
        this.ng2DragDropService.onDragEnd.next();
        this.onDragEnd.emit(e);
        e.stopPropagation();
        e.preventDefault();
    };
    Draggable.prototype.mousedown = function (e) {
        this.mouseDownElement = e.target;
    };
    Draggable.prototype.allowDrag = function () {
        if (this.dragHandle) {
            return dom_helper_1.DomHelper.matches(this.mouseDownElement, this.dragHandle) && this.dragEnabled;
        }
        else {
            return this.dragEnabled;
        }
    };
    Draggable.prototype.applyDragHandleClass = function () {
        var dragElement = this.getDragHandleElement();
        if (!dragElement) {
            return;
        }
        if (this.dragEnabled) {
            dom_helper_1.DomHelper.addClass(dragElement, this.dragHandleClass);
        }
        else {
            dom_helper_1.DomHelper.removeClass(this.el, this.dragHandleClass);
        }
    };
    Draggable.prototype.getDragHandleElement = function () {
        var dragElement = this.el;
        if (this.dragHandle) {
            dragElement = this.el.nativeElement.querySelector(this.dragHandle);
        }
        return dragElement;
    };
    Draggable.prototype.unbindDragListeners = function () {
        if (this.unbindDragListener) {
            this.unbindDragListener();
        }
    };
    /** @nocollapse */
    Draggable.ctorParameters = function () { return [
        { type: core_1.ElementRef },
        { type: core_1.Renderer2 },
        { type: ng_drag_drop_service_1.NgDragDropService },
        { type: core_1.NgZone }
    ]; };
    Draggable.propDecorators = {
        dragData: [{ type: core_1.Input }],
        dragHandle: [{ type: core_1.Input }],
        dragEffect: [{ type: core_1.Input }],
        dragScope: [{ type: core_1.Input }],
        dragHandleClass: [{ type: core_1.Input }],
        dragClass: [{ type: core_1.Input }],
        dragTransitClass: [{ type: core_1.Input }],
        dragImage: [{ type: core_1.Input }],
        dragEnabled: [{ type: core_1.HostBinding, args: ['draggable',] }, { type: core_1.Input }],
        onDragStart: [{ type: core_1.Output }],
        onDrag: [{ type: core_1.Output }],
        onDragEnd: [{ type: core_1.Output }],
        dragStart: [{ type: core_1.HostListener, args: ['dragstart', ['$event'],] }],
        dragEnd: [{ type: core_1.HostListener, args: ['dragend', ['$event'],] }],
        mousedown: [{ type: core_1.HostListener, args: ['mousedown', ['$event'],] }, { type: core_1.HostListener, args: ['touchstart', ['$event'],] }]
    };
Draggable.ɵfac = function Draggable_Factory(t) { return new (t || Draggable)(ɵngcc0.ɵɵdirectiveInject(ɵngcc0.ElementRef), ɵngcc0.ɵɵdirectiveInject(ɵngcc0.Renderer2), ɵngcc0.ɵɵdirectiveInject(ɵngcc1.NgDragDropService), ɵngcc0.ɵɵdirectiveInject(ɵngcc0.NgZone)); };
Draggable.ɵdir = /*@__PURE__*/ ɵngcc0.ɵɵdefineDirective({ type: Draggable, selectors: [["", "draggable", ""]], hostVars: 1, hostBindings: function Draggable_HostBindings(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵlistener("dragstart", function Draggable_dragstart_HostBindingHandler($event) { return ctx.dragStart($event); })("dragend", function Draggable_dragend_HostBindingHandler($event) { return ctx.dragEnd($event); })("mousedown", function Draggable_mousedown_HostBindingHandler($event) { return ctx.mousedown($event); })("touchstart", function Draggable_touchstart_HostBindingHandler($event) { return ctx.mousedown($event); });
    } if (rf & 2) {
        ɵngcc0.ɵɵhostProperty("draggable", ctx.dragEnabled);
    } }, inputs: { dragEffect: "dragEffect", dragScope: "dragScope", dragHandleClass: "dragHandleClass", dragClass: "dragClass", dragTransitClass: "dragTransitClass", dragImage: "dragImage", dragEnabled: "dragEnabled", dragData: "dragData", dragHandle: "dragHandle" }, outputs: { onDragStart: "onDragStart", onDrag: "onDrag", onDragEnd: "onDragEnd" } });
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && ɵngcc0.ɵsetClassMetadata(Draggable, [{
        type: core_1.Directive,
        args: [{
                selector: '[draggable]'
            }]
    }], function () { return [{ type: ɵngcc0.ElementRef }, { type: ɵngcc0.Renderer2 }, { type: ɵngcc1.NgDragDropService }, { type: ɵngcc0.NgZone }]; }, { dragEffect: [{
            type: core_1.Input
        }], dragScope: [{
            type: core_1.Input
        }], dragHandleClass: [{
            type: core_1.Input
        }], dragClass: [{
            type: core_1.Input
        }], dragTransitClass: [{
            type: core_1.Input
        }], onDragStart: [{
            type: core_1.Output
        }], onDrag: [{
            type: core_1.Output
        }], onDragEnd: [{
            type: core_1.Output
        }], dragImage: [{
            type: core_1.Input
        }], dragEnabled: [{
            type: core_1.HostBinding,
            args: ['draggable']
        }, {
            type: core_1.Input
        }], dragStart: [{
            type: core_1.HostListener,
            args: ['dragstart', ['$event']]
        }], dragEnd: [{
            type: core_1.HostListener,
            args: ['dragend', ['$event']]
        }], mousedown: [{
            type: core_1.HostListener,
            args: ['mousedown', ['$event']]
        }, {
            type: core_1.HostListener,
            args: ['touchstart', ['$event']]
        }], dragData: [{
            type: core_1.Input
        }], dragHandle: [{
            type: core_1.Input
        }] }); })();
    return Draggable;
}());
exports.Draggable = Draggable;

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHJhZ2dhYmxlLmRpcmVjdGl2ZS5qcyIsInNvdXJjZXMiOlsiZHJhZ2dhYmxlLmRpcmVjdGl2ZS5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOzs7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxNQUtNO0FBQ047QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7b0JBQU07QUFDTjtBQUNBO0FBQ0E7QUFDQSIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xyXG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgXCJfX2VzTW9kdWxlXCIsIHsgdmFsdWU6IHRydWUgfSk7XHJcbnZhciBjb3JlXzEgPSByZXF1aXJlKFwiQGFuZ3VsYXIvY29yZVwiKTtcclxudmFyIG5nX2RyYWdfZHJvcF9zZXJ2aWNlXzEgPSByZXF1aXJlKFwiLi4vc2VydmljZXMvbmctZHJhZy1kcm9wLnNlcnZpY2VcIik7XHJcbnZhciBkb21faGVscGVyXzEgPSByZXF1aXJlKFwiLi4vc2hhcmVkL2RvbS1oZWxwZXJcIik7XHJcbnZhciBEcmFnZ2FibGUgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoKSB7XHJcbiAgICBmdW5jdGlvbiBEcmFnZ2FibGUoZWwsIHJlbmRlcmVyLCBuZzJEcmFnRHJvcFNlcnZpY2UsIHpvbmUpIHtcclxuICAgICAgICB0aGlzLmVsID0gZWw7XHJcbiAgICAgICAgdGhpcy5yZW5kZXJlciA9IHJlbmRlcmVyO1xyXG4gICAgICAgIHRoaXMubmcyRHJhZ0Ryb3BTZXJ2aWNlID0gbmcyRHJhZ0Ryb3BTZXJ2aWNlO1xyXG4gICAgICAgIHRoaXMuem9uZSA9IHpvbmU7XHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICogQ3VycmVudGx5IG5vdCB1c2VkXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgdGhpcy5kcmFnRWZmZWN0ID0gJ21vdmUnO1xyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIERlZmluZXMgY29tcGF0aWJsZSBkcmFnIGRyb3AgcGFpcnMuIFZhbHVlcyBtdXN0IG1hdGNoIGJvdGggaW4gZHJhZ2dhYmxlIGFuZCBkcm9wcGFibGUuZHJvcFNjb3BlLlxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIHRoaXMuZHJhZ1Njb3BlID0gJ2RlZmF1bHQnO1xyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIFRoZSBDU1MgY2xhc3MgYXBwbGllZCB0byBhIGRyYWdnYWJsZSBlbGVtZW50LiBJZiBhIGRyYWdIYW5kbGUgaXMgZGVmaW5lZCB0aGVuIGl0cyBhcHBsaWVkIHRvIHRoYXQgaGFuZGxlXHJcbiAgICAgICAgICogZWxlbWVudCBvbmx5LiBCeSBkZWZhdWx0IGl0IGlzIHVzZWQgdG8gY2hhbmdlIHRoZSBtb3VzZSBvdmVyIHBvaW50ZXIuXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgdGhpcy5kcmFnSGFuZGxlQ2xhc3MgPSAnZHJhZy1oYW5kbGUnO1xyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIENTUyBjbGFzcyBhcHBsaWVkIG9uIHRoZSBzb3VyY2UgZHJhZ2dhYmxlIGVsZW1lbnQgd2hpbGUgYmVpbmcgZHJhZ2dlZC5cclxuICAgICAgICAgKi9cclxuICAgICAgICB0aGlzLmRyYWdDbGFzcyA9ICdkcmFnLWJvcmRlcic7XHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICogQ1NTIGNsYXNzIGFwcGxpZWQgb24gdGhlIGRyYWcgZ2hvc3Qgd2hlbiBiZWluZyBkcmFnZ2VkLlxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIHRoaXMuZHJhZ1RyYW5zaXRDbGFzcyA9ICdkcmFnLXRyYW5zaXQnO1xyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIEV2ZW50IGZpcmVkIHdoZW4gRHJhZyBpcyBzdGFydGVkXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgdGhpcy5vbkRyYWdTdGFydCA9IG5ldyBjb3JlXzEuRXZlbnRFbWl0dGVyKCk7XHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICogRXZlbnQgZmlyZWQgd2hpbGUgdGhlIGVsZW1lbnQgaXMgYmVpbmcgZHJhZ2dlZFxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIHRoaXMub25EcmFnID0gbmV3IGNvcmVfMS5FdmVudEVtaXR0ZXIoKTtcclxuICAgICAgICAvKipcclxuICAgICAgICAgKiBFdmVudCBmaXJlZCB3aGVuIGRyYWcgZW5kc1xyXG4gICAgICAgICAqL1xyXG4gICAgICAgIHRoaXMub25EcmFnRW5kID0gbmV3IGNvcmVfMS5FdmVudEVtaXR0ZXIoKTtcclxuICAgICAgICAvKipcclxuICAgICAgICAgKiBAcHJpdmF0ZVxyXG4gICAgICAgICAqIEJhY2tpbmcgZmllbGQgZm9yIHRoZSBkcmFnRW5hYmxlZCBwcm9wZXJ0eVxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIHRoaXMuX2RyYWdFbmFibGVkID0gdHJ1ZTtcclxuICAgIH1cclxuICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShEcmFnZ2FibGUucHJvdG90eXBlLCBcImRyYWdJbWFnZVwiLCB7XHJcbiAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLl9kcmFnSW1hZ2U7XHJcbiAgICAgICAgfSxcclxuICAgICAgICAvKipcclxuICAgICAgICAgKiBUaGUgdXJsIHRvIGltYWdlIHRoYXQgd2lsbCBiZSB1c2VkIGFzIGN1c3RvbSBkcmFnIGltYWdlIHdoZW4gdGhlIGRyYWdnYWJsZSBpcyBiZWluZyBkcmFnZ2VkLlxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7XHJcbiAgICAgICAgICAgIHRoaXMuX2RyYWdJbWFnZSA9IHZhbHVlO1xyXG4gICAgICAgICAgICB0aGlzLmRyYWdJbWFnZUVsZW1lbnQgPSBuZXcgSW1hZ2UoKTtcclxuICAgICAgICAgICAgdGhpcy5kcmFnSW1hZ2VFbGVtZW50LnNyYyA9IHRoaXMuZHJhZ0ltYWdlO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSxcclxuICAgICAgICBjb25maWd1cmFibGU6IHRydWVcclxuICAgIH0pO1xyXG4gICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KERyYWdnYWJsZS5wcm90b3R5cGUsIFwiZHJhZ0VuYWJsZWRcIiwge1xyXG4gICAgICAgIGdldDogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5fZHJhZ0VuYWJsZWQ7XHJcbiAgICAgICAgfSxcclxuICAgICAgICAvKipcclxuICAgICAgICAgKiBEZWZpbmVzIGlmIGRyYWcgaXMgZW5hYmxlZC4gYHRydWVgIGJ5IGRlZmF1bHQuXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHtcclxuICAgICAgICAgICAgdGhpcy5fZHJhZ0VuYWJsZWQgPSB2YWx1ZTtcclxuICAgICAgICAgICAgdGhpcy5hcHBseURyYWdIYW5kbGVDbGFzcygpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSxcclxuICAgICAgICBjb25maWd1cmFibGU6IHRydWVcclxuICAgIH0pO1xyXG4gICAgO1xyXG4gICAgRHJhZ2dhYmxlLnByb3RvdHlwZS5uZ09uSW5pdCA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB0aGlzLmFwcGx5RHJhZ0hhbmRsZUNsYXNzKCk7XHJcbiAgICB9O1xyXG4gICAgRHJhZ2dhYmxlLnByb3RvdHlwZS5uZ09uRGVzdHJveSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB0aGlzLnVuYmluZERyYWdMaXN0ZW5lcnMoKTtcclxuICAgIH07XHJcbiAgICBEcmFnZ2FibGUucHJvdG90eXBlLmRyYWdTdGFydCA9IGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgICAgICBpZiAodGhpcy5hbGxvd0RyYWcoKSkge1xyXG4gICAgICAgICAgICAvLyBUaGlzIGlzIGEga2x1ZGd5IGFwcHJvYWNoIHRvIGFwcGx5IENTUyB0byB0aGUgZHJhZyBoZWxwZXIgZWxlbWVudCB3aGVuIGFuIGltYWdlIGlzIGJlaW5nIGRyYWdnZWQuXHJcbiAgICAgICAgICAgIGRvbV9oZWxwZXJfMS5Eb21IZWxwZXIuYWRkQ2xhc3ModGhpcy5lbCwgdGhpcy5kcmFnVHJhbnNpdENsYXNzKTtcclxuICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICBkb21faGVscGVyXzEuRG9tSGVscGVyLmFkZENsYXNzKF90aGlzLmVsLCBfdGhpcy5kcmFnQ2xhc3MpO1xyXG4gICAgICAgICAgICAgICAgZG9tX2hlbHBlcl8xLkRvbUhlbHBlci5yZW1vdmVDbGFzcyhfdGhpcy5lbCwgX3RoaXMuZHJhZ1RyYW5zaXRDbGFzcyk7XHJcbiAgICAgICAgICAgIH0sIDEwKTtcclxuICAgICAgICAgICAgdGhpcy5uZzJEcmFnRHJvcFNlcnZpY2UuZHJhZ0RhdGEgPSB0aGlzLmRyYWdEYXRhO1xyXG4gICAgICAgICAgICB0aGlzLm5nMkRyYWdEcm9wU2VydmljZS5zY29wZSA9IHRoaXMuZHJhZ1Njb3BlO1xyXG4gICAgICAgICAgICAvLyBGaXJlZm94IHJlcXVpcmVzIHNldERhdGEoKSB0byBiZSBjYWxsZWQgb3RoZXJ3aXNlIHRoZSBkcmFnIGRvZXMgbm90IHdvcmsuXHJcbiAgICAgICAgICAgIC8vIFdlIGRvbid0IHVzZSBzZXREYXRhKCkgdG8gdHJhbnNmZXIgZGF0YSBhbnltb3JlIHNvIHRoaXMgaXMganVzdCBhIGR1bW15IGNhbGwuXHJcbiAgICAgICAgICAgIGlmIChlLmRhdGFUcmFuc2ZlciAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICBlLmRhdGFUcmFuc2Zlci5zZXREYXRhKCd0ZXh0JywgJycpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIC8vIFNldCBkcmFnSW1hZ2VcclxuICAgICAgICAgICAgaWYgKHRoaXMuZHJhZ0ltYWdlKSB7XHJcbiAgICAgICAgICAgICAgICBlLmRhdGFUcmFuc2Zlci5zZXREcmFnSW1hZ2UodGhpcy5kcmFnSW1hZ2VFbGVtZW50LCAwLCAwKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpO1xyXG4gICAgICAgICAgICB0aGlzLm9uRHJhZ1N0YXJ0LmVtaXQoZSk7XHJcbiAgICAgICAgICAgIHRoaXMubmcyRHJhZ0Ryb3BTZXJ2aWNlLm9uRHJhZ1N0YXJ0Lm5leHQoKTtcclxuICAgICAgICAgICAgdGhpcy56b25lLnJ1bk91dHNpZGVBbmd1bGFyKGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgIF90aGlzLnVuYmluZERyYWdMaXN0ZW5lciA9IF90aGlzLnJlbmRlcmVyLmxpc3RlbihfdGhpcy5lbC5uYXRpdmVFbGVtZW50LCAnZHJhZycsIGZ1bmN0aW9uIChkcmFnRXZlbnQpIHtcclxuICAgICAgICAgICAgICAgICAgICBfdGhpcy5kcmFnKGRyYWdFdmVudCk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIERyYWdnYWJsZS5wcm90b3R5cGUuZHJhZyA9IGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgICAgdGhpcy5vbkRyYWcuZW1pdChlKTtcclxuICAgIH07XHJcbiAgICBEcmFnZ2FibGUucHJvdG90eXBlLmRyYWdFbmQgPSBmdW5jdGlvbiAoZSkge1xyXG4gICAgICAgIHRoaXMudW5iaW5kRHJhZ0xpc3RlbmVycygpO1xyXG4gICAgICAgIGRvbV9oZWxwZXJfMS5Eb21IZWxwZXIucmVtb3ZlQ2xhc3ModGhpcy5lbCwgdGhpcy5kcmFnQ2xhc3MpO1xyXG4gICAgICAgIHRoaXMubmcyRHJhZ0Ryb3BTZXJ2aWNlLm9uRHJhZ0VuZC5uZXh0KCk7XHJcbiAgICAgICAgdGhpcy5vbkRyYWdFbmQuZW1pdChlKTtcclxuICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpO1xyXG4gICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcclxuICAgIH07XHJcbiAgICBEcmFnZ2FibGUucHJvdG90eXBlLm1vdXNlZG93biA9IGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgICAgdGhpcy5tb3VzZURvd25FbGVtZW50ID0gZS50YXJnZXQ7XHJcbiAgICB9O1xyXG4gICAgRHJhZ2dhYmxlLnByb3RvdHlwZS5hbGxvd0RyYWcgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuZHJhZ0hhbmRsZSkge1xyXG4gICAgICAgICAgICByZXR1cm4gZG9tX2hlbHBlcl8xLkRvbUhlbHBlci5tYXRjaGVzKHRoaXMubW91c2VEb3duRWxlbWVudCwgdGhpcy5kcmFnSGFuZGxlKSAmJiB0aGlzLmRyYWdFbmFibGVkO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZHJhZ0VuYWJsZWQ7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIERyYWdnYWJsZS5wcm90b3R5cGUuYXBwbHlEcmFnSGFuZGxlQ2xhc3MgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdmFyIGRyYWdFbGVtZW50ID0gdGhpcy5nZXREcmFnSGFuZGxlRWxlbWVudCgpO1xyXG4gICAgICAgIGlmICghZHJhZ0VsZW1lbnQpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAodGhpcy5kcmFnRW5hYmxlZCkge1xyXG4gICAgICAgICAgICBkb21faGVscGVyXzEuRG9tSGVscGVyLmFkZENsYXNzKGRyYWdFbGVtZW50LCB0aGlzLmRyYWdIYW5kbGVDbGFzcyk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICBkb21faGVscGVyXzEuRG9tSGVscGVyLnJlbW92ZUNsYXNzKHRoaXMuZWwsIHRoaXMuZHJhZ0hhbmRsZUNsYXNzKTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgRHJhZ2dhYmxlLnByb3RvdHlwZS5nZXREcmFnSGFuZGxlRWxlbWVudCA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB2YXIgZHJhZ0VsZW1lbnQgPSB0aGlzLmVsO1xyXG4gICAgICAgIGlmICh0aGlzLmRyYWdIYW5kbGUpIHtcclxuICAgICAgICAgICAgZHJhZ0VsZW1lbnQgPSB0aGlzLmVsLm5hdGl2ZUVsZW1lbnQucXVlcnlTZWxlY3Rvcih0aGlzLmRyYWdIYW5kbGUpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gZHJhZ0VsZW1lbnQ7XHJcbiAgICB9O1xyXG4gICAgRHJhZ2dhYmxlLnByb3RvdHlwZS51bmJpbmREcmFnTGlzdGVuZXJzID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIGlmICh0aGlzLnVuYmluZERyYWdMaXN0ZW5lcikge1xyXG4gICAgICAgICAgICB0aGlzLnVuYmluZERyYWdMaXN0ZW5lcigpO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBEcmFnZ2FibGUuZGVjb3JhdG9ycyA9IFtcclxuICAgICAgICB7IHR5cGU6IGNvcmVfMS5EaXJlY3RpdmUsIGFyZ3M6IFt7XHJcbiAgICAgICAgICAgICAgICAgICAgc2VsZWN0b3I6ICdbZHJhZ2dhYmxlXSdcclxuICAgICAgICAgICAgICAgIH0sXSB9LFxyXG4gICAgXTtcclxuICAgIC8qKiBAbm9jb2xsYXBzZSAqL1xyXG4gICAgRHJhZ2dhYmxlLmN0b3JQYXJhbWV0ZXJzID0gZnVuY3Rpb24gKCkgeyByZXR1cm4gW1xyXG4gICAgICAgIHsgdHlwZTogY29yZV8xLkVsZW1lbnRSZWYgfSxcclxuICAgICAgICB7IHR5cGU6IGNvcmVfMS5SZW5kZXJlcjIgfSxcclxuICAgICAgICB7IHR5cGU6IG5nX2RyYWdfZHJvcF9zZXJ2aWNlXzEuTmdEcmFnRHJvcFNlcnZpY2UgfSxcclxuICAgICAgICB7IHR5cGU6IGNvcmVfMS5OZ1pvbmUgfVxyXG4gICAgXTsgfTtcclxuICAgIERyYWdnYWJsZS5wcm9wRGVjb3JhdG9ycyA9IHtcclxuICAgICAgICBkcmFnRGF0YTogW3sgdHlwZTogY29yZV8xLklucHV0IH1dLFxyXG4gICAgICAgIGRyYWdIYW5kbGU6IFt7IHR5cGU6IGNvcmVfMS5JbnB1dCB9XSxcclxuICAgICAgICBkcmFnRWZmZWN0OiBbeyB0eXBlOiBjb3JlXzEuSW5wdXQgfV0sXHJcbiAgICAgICAgZHJhZ1Njb3BlOiBbeyB0eXBlOiBjb3JlXzEuSW5wdXQgfV0sXHJcbiAgICAgICAgZHJhZ0hhbmRsZUNsYXNzOiBbeyB0eXBlOiBjb3JlXzEuSW5wdXQgfV0sXHJcbiAgICAgICAgZHJhZ0NsYXNzOiBbeyB0eXBlOiBjb3JlXzEuSW5wdXQgfV0sXHJcbiAgICAgICAgZHJhZ1RyYW5zaXRDbGFzczogW3sgdHlwZTogY29yZV8xLklucHV0IH1dLFxyXG4gICAgICAgIGRyYWdJbWFnZTogW3sgdHlwZTogY29yZV8xLklucHV0IH1dLFxyXG4gICAgICAgIGRyYWdFbmFibGVkOiBbeyB0eXBlOiBjb3JlXzEuSG9zdEJpbmRpbmcsIGFyZ3M6IFsnZHJhZ2dhYmxlJyxdIH0sIHsgdHlwZTogY29yZV8xLklucHV0IH1dLFxyXG4gICAgICAgIG9uRHJhZ1N0YXJ0OiBbeyB0eXBlOiBjb3JlXzEuT3V0cHV0IH1dLFxyXG4gICAgICAgIG9uRHJhZzogW3sgdHlwZTogY29yZV8xLk91dHB1dCB9XSxcclxuICAgICAgICBvbkRyYWdFbmQ6IFt7IHR5cGU6IGNvcmVfMS5PdXRwdXQgfV0sXHJcbiAgICAgICAgZHJhZ1N0YXJ0OiBbeyB0eXBlOiBjb3JlXzEuSG9zdExpc3RlbmVyLCBhcmdzOiBbJ2RyYWdzdGFydCcsIFsnJGV2ZW50J10sXSB9XSxcclxuICAgICAgICBkcmFnRW5kOiBbeyB0eXBlOiBjb3JlXzEuSG9zdExpc3RlbmVyLCBhcmdzOiBbJ2RyYWdlbmQnLCBbJyRldmVudCddLF0gfV0sXHJcbiAgICAgICAgbW91c2Vkb3duOiBbeyB0eXBlOiBjb3JlXzEuSG9zdExpc3RlbmVyLCBhcmdzOiBbJ21vdXNlZG93bicsIFsnJGV2ZW50J10sXSB9LCB7IHR5cGU6IGNvcmVfMS5Ib3N0TGlzdGVuZXIsIGFyZ3M6IFsndG91Y2hzdGFydCcsIFsnJGV2ZW50J10sXSB9XVxyXG4gICAgfTtcclxuICAgIHJldHVybiBEcmFnZ2FibGU7XHJcbn0oKSk7XHJcbmV4cG9ydHMuRHJhZ2dhYmxlID0gRHJhZ2dhYmxlO1xyXG4iXX0=